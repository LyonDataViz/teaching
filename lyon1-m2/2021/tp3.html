<!DOCTYPE html>
<html>
<head>
	<meta charset='utf-8'>
	<meta http-equiv="X-UA-Compatible" content="chrome=1">
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#157878">
	<link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="/teaching/assets/css/style.css?v=7711d6911e9680d4af53ac0eaf8745f6cb14632c">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>TP3 DataViz Lyon1 M2 2021-2022</title>
</head>


<body>
	<section class="page-header">
		<h1 class="project-name">TP3 DataViz: Données spatiales avec D3.js</h1>
		<h2 class="project-tagline">Université Lyon 1, Master 2, 2021-2022</h2>
	</section>


		<section class="main-content">
				<h3>Objectif du TP</h3>

				<p>1. Réaliser une carte du covid en France similaire à celle ci-dessous.</p>

				<img width="80%" src="images/tp3-tooltip.png">

		        <h3>Rendu pour ce TP</h2>

		        <p>Le rendu final est à faire sur Tomuss. Le TP peut se faire en binôme.</p>

				<p>Le TP sera noté 0, 1, ou 2. Si vous arrivez à la partie 4, vous aurez 1 (=10/20), si vous arrivez à la fin 2 (=20/20).</p>

				<h4>1. Chargement du fond de carte</h4>
					<p>Charger le <a href="https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements-version-simplifiee.geojson">fond de carte des départements français métropolitains</a> avec D3.js.</p>
					<p>Voir l'exemple vu en cours:</p>

					<iframe src="https://codesandbox.io/embed/d3-carto-tp3-72vry?fontsize=13&hidenavigation=1&theme=dark"
					     style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;"
					     title="d3-carto-tp3"
					     sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"
					   ></iframe>

					<p>Dans l'exemple du cours nous utilisons une projection Américaine. Basculez sur une projection plus générique comme <code>d3.geoConicConformal</code>. Nous utilisons la v7 de D3.js <a href="https://github.com/d3/d3-geo-projection">la page de référence sur les projections est ici</a>.</p>

					<p>Positioner la carte sur la France, en utilisant la projection suivante : <code>d3.geoConicConformal().center([2.454071, 46.279229]).scale(2800);</code></p>

				<h4>2. Chargement des données</h4>
					<p>Charger les données covid, pour commencer nous allons démarrer avec un <a href="https://lyondataviz.github.io/teaching/lyon1-m2/2021/data/covid-06-11-2021.csv">sous ensemble des données allant de juin à novembre 2021</a> en métropole (plutôt que le jeu de <a href="https://www.data.gouv.fr/fr/datasets/r/63352e38-d353-4b54-bfd1-f1b3ee1cabd7">données</a> entier.) En vous inspirant du code vu en cours les afficher sur la carte (voir la structure ci-dessous). On va filtrer les donnees pour ne garder que les lignes ou sexe == 0 (tous les genres, plutôt que 1 ou 2 = homme ou femme)</p>

					<p>Nous utilisons le fichier geojson <a href="https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements-version-simplifiee.geojson">suivant, décrivant les départements français métropolitain</a>.</p>

					<p>Utiliser la colonne <code>hosp</code> du tableau CSV, pour récupérer les hospitalisations du département pour un jour donné.<br/>
				  	<code>var dataValue = parseInt(data[i].hosp); </code>
					</p>

					<pre><code>
var jourChoisi = "2021-09-12" // pour demarrer on code en dur un jour a afficher

d3.csv("covid.csv").then(function(data) {

    // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/filter
    var cleanData = data.filter( TODO ); // TODO ne garder que les lignes ou (sexe == 0)

    color.domain([0, 2000]);

    d3.json("departements-version-simplifiee.geojson").then(function(json) {
        //On fusionne les donnees avec le GeoJSON des departements

        //On parcours les departements du GeoJSON un par un
        for (var j = 0; j < json.features.length; j++) {
			var departement = json.features.TODO // TODO

            // find permet d'eviter de faire une boucle sur toutes les donnees 
            // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/find#find_an_object_in_an_array_by_one_of_its_properties
            var jourDepChoisi = cleanData.find(function(row) {
                return TODO; // find renvoie la ligne du tableau si la fonction qu'on lui passe en argument renvoie True.    
            })
            json.features[j].properties.value = jourDepChoisi.hosp;
	  }

      // on dessine
      svg.selectAll("path")
      ...
        .style("fill", function(d) {
              var value = d.properties.value;
              ...
      });
    });
});
					</code></pre>



				<h4>3. Afficher les données d'une journée</h4>
				<p><code>data[i].jour</code> permet d'accéder au jour courant pour la ligne i du tableau, <code>data[i].hosp</code> permet d'accéder aux hospitalisations. Un fichier de méta-données décrivant les colonnes <a href="https://www.data.gouv.fr/fr/datasets/r/3f0f1885-25f4-4102-bbab-edec5a58e34a">est disponible ici</a>.</p>


				<h4>4. Ajuster l'échelle des couleurs.</h4>
				<p>L'échelle des couleurs a été définie sur un domaine donné avec un minimum d'hospitalisations à 0 et un max à 2000. </p>
				<p>En vous inspirant de l'exemple vu en cours, adaptez le calcul du domaine en utilisant d3.min et d3.max. </p>

				<h4>5. Tooltip</h4>
				<p>En vous inspirant du <a href="https://vizhub.com/aurelient/1c9e4767f4e346a6b159799490a88708?edit=files&file=index.html">code suivant</a> ajouter un tooltip avec le nom et la valeur de la région. La gestion des événements a changé avec d3v6 ( <a href="https://observablehq.com/@d3/d3v6-migration-guide">voir ici</a> = faites attention aux exemples que vous regardez).</p>

				<!-- <h4>5. Affichage d'un barchart temporel</h4>
				<p>En reprenant les barcharts vus dans le TP D3 précédent, ou <a href="https://blockbuilder.org/aurelient/18976d5e9cfa0953799e9d165a788e7b">cet exemple</a>, rajouter un barchart en dessous de la carte qui montre l'évolution sur toutes les semaines de 2014.</p>
 				-->


				 <h4>Mi-chemin</h4>
				 <p>Si vous arrivez à ce stade vous pouvez soumettre vous aurez 1/2.</p>

				 <p>Sauvegarder votre projet à ce stade pour pouvoir y revenir en cas de problème par la suite.</p>

				<h4>6. Traitement des données</h4>

				<p>Nous allons maintenant élargir le jeu de données. Cette fois ci, à la place d'injecter une valeur donnée dans l'objet geojson, nous allons injecter un tableau des valeurs quotidiennes pour un département donné. En pratique il faut de remplacer votre find(...), par un filter(...) qui va ne garder que les lignes correspondant à un département.
				</p>

				<h4>7. Dessiner la carte pour un jour donné</h4>

				<p>Bouger le code de dessin de la carte dans une fonction dediée. Que vous appelerez après le chargement et le traitement de vos données avec l'argument 0 (correspondant normalement au 2021-06-01). Modifier votre code de dessin pour récupérer la valeur d'hospitalisation pour le jour passé en argument (normalement l'argument correspond à la position dans le tableau que vous avez crée juste au-dessus).</p>

				<pre><code>
function drawMap(currentDay) {
  carte = svg.selectAll("path").data(json.features);

  carte.join("path")
    .attr("class", "enter")
    ...
}
</code></pre>


				<h4>8. Ajout d'un slider temporel</h4>
					<p>Rajouter un slider qui permettra de naviguer entre les différents jour du jeu de données (il y en a 178 du 1e juin au 25 novembre 2021).</p>

					<pre><code>&lt;div&gt;
  &lt;input id="slider" type="range" value="0" min="0" max="178" step="1" /&gt;&lt;br/&gt;
  &lt;span id="day"&gt;day&lt;/span&gt;
&lt;/div&gt;</code></pre>

					<p>On ajoutera aussi un élement textuel (dans le <code>span</code>) pour afficher la valeur du slider, et s'assurer ainsi que les évènements sont bien capturés par le code javascript plus tard.</p>


				<h4>9. Modification des données à afficher</h4>
				<p>Ajouter un listener sur le slider, qui appellera une fonction <code>updateViz</code> en cas de changement, pour mettre à jour la visualisation:</p>

				<pre><code>
d3.select("#slider").on("input", function() {
    drawMap(+this.value);
});
				</code></pre>

				<p>Dans drawMap faites en sorte qu'en cas de changement du slider, le texte sous le slider affiche la semaine sélectionnée.</p>

				<pre><code>d3.select('#day').html( valeur de la semaine selectionnée );</code></pre>

			</section>

    <script src="../javascripts/scale.fix.js"></script>

</body>
</html>
